<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ML Pipeline Web UI</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>ML Pipeline Web UI</h1>

    <!-- Clean Data Form -->
    <form id="cleanDataForm" enctype="multipart/form-data">
        <label for="csv_file">CSV File:</label>
        <input type="file" id="csv_file" name="csv_file" required>
        <button type="submit">Clean Data</button>
    </form>
    <div id="cleanDataResult"></div>

    <!-- Train Model Form -->
    <form id="trainModelForm" style="display: none;">
        <button type="submit">Train Model</button>
    </form>
    <div id="trainModelResult"></div>

    <!-- Test Model Form -->
    <form id="testModelForm" style="display: none;">
        <button type="submit">Test Model</button>
    </form>
    <div id="testModelResult"></div>

    <script>
        $(document).ready(function() {
            let cleanedData = null;
            let model = null;

            // Handle Clean Data Form Submission
            $('#cleanDataForm').submit(function(event) {
                event.preventDefault();
                $('#cleanDataResult').text('Cleaning data...');
                
                const formData = new FormData();
                formData.append('csv_file', $('#csv_file')[0].files[0]);

                $.ajax({
                    url: '/clean_data',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data) {
                        if (data.error) {
                            $('#cleanDataResult').html(`<p style="color: red;">Error: ${data.error}</p>`);
                        } else {
                            $('#cleanDataResult').html('<p>Data cleaned successfully!</p>');
                            cleanedData = data;
                            $('#trainModelForm').show();
                        }
                    },
                    error: function(xhr) {
                        $('#cleanDataResult').html(`<p style="color: red;">Error: ${xhr.responseJSON.error}</p>`);
                    }
                });
            });

            // Handle Train Model Form Submission
            $('#trainModelForm').submit(function(event) {
                event.preventDefault();
                $('#trainModelResult').text('Training model...');
                
                $.ajax({
                    type: 'POST',
                    url: '/train_model',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        x_train: cleanedData.x_train,
                        y_train: cleanedData.y_train
                    }),
                    success: function(data) {
                        if (data.error) {
                            $('#trainModelResult').html(`<p style="color: red;">Error: ${data.error}</p>`);
                        } else {
                            $('#trainModelResult').html('<p>Model trained successfully!</p>');
                            model = data.model;
                            $('#testModelForm').show();
                        }
                    },
                    error: function(xhr) {
                        $('#trainModelResult').html(`<p style="color: red;">Error: ${xhr.responseJSON.error}</p>`);
                    }
                });
            });

            // Handle Test Model Form Submission
            $('#testModelForm').submit(function(event) {
                event.preventDefault();
                $('#testModelResult').text('Testing model...');
                
                $.ajax({
                    type: 'POST',
                    url: '/test_model',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        model: model,
                        x_test: cleanedData.x_test,
                        y_test: cleanedData.y_test,
                        dates_test: cleanedData.dates_test
                    }),
                    success: function(data) {
                        if (data.error) {
                            $('#testModelResult').html(`<p style="color: red;">Error: ${data.error}</p>`);
                        } else {
                            $('#testModelResult').html(`
                                <p>RMSE: ${data.rmse}</p>
                                <img src="data:image/png;base64,${data.plot}" alt="Plot Image">
                            `);
                        }
                    },
                    error: function(xhr) {
                        $('#testModelResult').html(`<p style="color: red;">Error: ${xhr.responseJSON.error}</p>`);
                    }
                });
            });
        });
    </script>
</body>
</html>
